<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>e.nue Dashboard</title>

<style>
:root{
  --bg1:#e3ddd4;
  --bg2:#d4ccc1;

  --glass-bg: rgba(255,255,255,.86);
  --glass-bg2: rgba(255,255,255,.78);
  --glass-border: rgba(0,0,0,.06);
  --line-soft: rgba(0,0,0,.10);
  --shadow: 0 18px 45px rgba(0,0,0,.14);

  --text-main:#222222;
  --text-sub:#555555;
  --muted: rgba(34,34,34,.55);

  --accent:#e18a6a;
  --accent2:#d06463;

  --ok:#2fbf7a;
  --wait:#f0a33a;
  --done:#6d78d8;
  --todo:#9097a6;

  --r:18px;
  --maxw:980px;
}

*{ box-sizing:border-box; }
html, body{ height:100%; }

body{
  margin:0;
  font-family: system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
  color:var(--text-main);
  background:
    radial-gradient(1200px 800px at 18% 8%, rgba(225,138,106,.18), transparent 55%),
    radial-gradient(1200px 800px at 88% 0%, rgba(208,100,99,.14), transparent 52%),
    linear-gradient(135deg,var(--bg1),var(--bg2));
}

.safe{
  padding:max(14px,env(safe-area-inset-top)) 14px max(18px,env(safe-area-inset-bottom));
  max-width:var(--maxw);
  margin:0 auto;
}

/* ===== top bar ===== */
.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:6px 0 14px;
}
.brand{ font-weight:900; letter-spacing:.02em; }

.tabs{
  display:flex; gap:4px; padding:4px;
  border-radius:999px;
  background:rgba(255,255,255,.55);
  border:1px solid var(--glass-border);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}
.tab{
  border:0; background:transparent;
  padding:10px 14px; border-radius:999px;
  font-weight:800; cursor:pointer;
  color:rgba(34,34,34,.65);
}
.tab.active{
  background:rgba(255,255,255,.85);
  color:var(--text-main);
  box-shadow:0 8px 18px rgba(0,0,0,.08);
}

/* ===== layout ===== */
.grid{ display:flex; flex-direction:column; gap:14px; }

.card{
  background:linear-gradient(180deg,var(--glass-bg),var(--glass-bg2));
  border:1px solid var(--glass-border);
  border-radius:var(--r);
  box-shadow:var(--shadow);
  overflow:hidden;
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}

/* =====================================================
   â€œé3Dâ€ flipï¼ˆSafariã§ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å£Šã‚Œãªã„ï¼‰
===================================================== */
.cardFlip{ position:relative; }
.cardFlipInner{
  position:relative;
  min-height:360px;
}

/* 2é¢ã‚’é‡ã­ã¦ãƒ•ã‚§ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆtransformç„¡ã—ï¼‰ */
.cardFace{
  position:absolute;
  inset:0;
  background: linear-gradient(180deg,var(--glass-bg),var(--glass-bg2));
  opacity:0;
  pointer-events:none;
  transition: opacity .28s ease;
}
.cardFace.front{ opacity:1; pointer-events:auto; }
.cardFlip.is-flipped .cardFace.front{ opacity:0; pointer-events:none; }
.cardFlip.is-flipped .cardFace.back { opacity:1; pointer-events:auto; }

/* åˆ‡æ›¿æ™‚ã®â€œã¬ã‚‹ã£ã¨æ„Ÿâ€ */
.cardFace .chartInnerSwitch{
  transform-origin:50% 50%;
}
.cardFlip.is-animating .cardFace{
  filter: blur(.6px);
}
@media (prefers-reduced-motion: reduce){
  .cardFace{ transition:none; }
  .cardFlip.is-animating .cardFace{ filter:none; }
}

/* ===== card head ===== */
.cardHead{
  display:flex; justify-content:space-between;
  gap:10px;
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(0,0,0,.06);
}
.title .h{ font-weight:900; font-size:14px; letter-spacing:.06em; }
.title .s{ font-size:12px; color:rgba(34,34,34,.6); }
.badgeBig{ text-align:right; }
.badgeBig .k{ font-size:11px; font-weight:800; color:rgba(34,34,34,.55); }
.badgeBig .v{ font-size:18px; font-weight:900; }

/* ===== chart ===== */
.chartWrap{
  padding:12px 0;
  overflow:hidden;
}
.chartFrame{ position:relative; padding:0 12px 10px; }

.yAxisFixed{
  position:absolute; left:12px; top:0;
  width:42px; height:220px;
  pointer-events:none;
  z-index:2;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼ˆã“ã‚ŒãŒæœ¬ä½“ï¼‰ */
.chartScroller{
  overflow-x:auto;
  overflow-y:hidden;
  -webkit-overflow-scrolling:touch;
  touch-action: pan-x;
}

/* å·¦ä½™ç™½ï¼ˆYè»¸å›ºå®šåˆ†ï¼‰ */
.chartInner{
  padding-left:42px;
  display:inline-block;          /* â˜…ä¸­èº«ã®å¹…ã§ä¼¸ã³ã‚‹ */
}
.chartMount{
  display:inline-block;          /* â˜…ä¸­èº«ã®å¹…ã§ä¼¸ã³ã‚‹ */
}
/* SVGã¯ãƒ–ãƒ­ãƒƒã‚¯åŒ–ï¼ˆå¹…è¨ˆç®—ãŒå®‰å®šï¼‰ */
.chartMount svg{
  display:block;
  pointer-events:none;
  user-select:none;
  -webkit-user-select:none;
}

.hint{ padding:0 14px 14px; font-size:12px; color:rgba(34,34,34,.55); }
.tapHint{
  display:inline-flex; gap:8px; align-items:center;
  padding:8px 10px; border-radius:999px;
  background:rgba(255,255,255,.62);
  border:1px solid rgba(0,0,0,.06);
  cursor:pointer;
  user-select:none;
  -webkit-user-select:none;
}

/* ===== tooltipï¼ˆSVGå†…ï¼‰ ===== */
.chartTooltip{ pointer-events:none; }
.chartTooltip rect{ fill: rgba(34,34,34,.92); rx:8; }
.chartTooltip text{ fill:#fff; font-size:12px; font-weight:900; }

/* ===== calendar ===== */
.calendar{ padding:12px; }

.calBox{
  position:relative; border-radius:14px; overflow:hidden;
  border:1px solid rgba(0,0,0,.08);
  background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,.52));
}
.calBg{
  position:absolute; inset:0;
  background:
    radial-gradient(600px 360px at 20% 20%, rgba(255,255,255,.55), transparent 60%),
    radial-gradient(600px 420px at 80% 30%, rgba(225,138,106,.22), transparent 60%);
}
.calGlass{
  position:relative;
  padding:10px;
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
}
.calTop{ display:flex; justify-content:space-between; padding:6px 4px 10px; font-weight:900; }

.calGrid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:1px;
  background:rgba(0,0,0,.08);
  border-radius:12px;
  overflow:hidden;
}
.dow,.day{ min-height:46px; padding:6px; font-size:12px; background:rgba(255,255,255,.45); }
.dow{ text-align:center; font-weight:900; background:rgba(255,255,255,.65); }
.day{ position:relative; }
.num{ position:absolute; top:6px; left:6px; font-weight:900; }

.pill{
  display:inline-block;
  margin-top:18px; padding:4px 8px; border-radius:999px;
  font-size:11px; font-weight:900;
  background:rgba(255,255,255,.75);
  border:1px solid rgba(0,0,0,.06);
}
.pill.accent{
  color:#fff;
  background:linear-gradient(180deg,rgba(225,138,106,.95),rgba(208,100,99,.92));
}
.pill.soft{
  color:rgba(34,34,34,.72);
  background:rgba(255,255,255,.68);
}

/* ===== table ===== */
.listTitle{ padding:12px 14px 6px; font-weight:900; }
.list{ padding:10px 12px 12px; }

.tableWrap{
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  touch-action: pan-x pan-y;
  border-radius:14px;
}
.table{
  width:100%; min-width:520px;
  border-collapse:separate; border-spacing:0;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  background:rgba(255,255,255,.55);
}
.thead th{
  position:sticky; top:0;
  padding:10px;
  font-size:12px; font-weight:900;
  background:rgba(255,255,255,.7);
  z-index:1;
}
.row td{ padding:10px; border-bottom:1px solid rgba(0,0,0,.06); }

.status{
  display:inline-flex; gap:8px; align-items:center;
  padding:6px 10px;
  border-radius:999px;
  font-size:12px; font-weight:900;
  background:rgba(255,255,255,.68);
}
.dot{ width:10px; height:10px; border-radius:999px; }
.st-doing .dot{ background:var(--ok); }
.st-wait  .dot{ background:var(--wait); }
.st-done  .dot{ background:var(--done); }
.st-todo  .dot{ background:var(--todo); }
</style>
</head>

<body>
  <div class="safe">
    <div class="topbar">
      <div class="brand">e.nue</div>
      <div class="tabs" role="tablist" aria-label="page switch">
        <button class="tab active" data-view="home" type="button">HOME</button>
        <button class="tab" data-view="other" type="button">OTHER</button>
      </div>
    </div>

    <!-- HOME -->
    <main id="view-home" class="grid">

      <!-- 1) ã‚°ãƒ©ãƒ•ï¼ˆåˆ‡æ›¿ï¼‰ -->
      <section class="card cardFlip" id="card-chart">
        <div class="cardFlipInner">

          <!-- FRONTï¼šå—æ³¨ä»¶æ•° -->
          <div class="cardFace front">
            <div class="cardHead">
              <div class="title">
                <div class="h" id="chartTitleA">å—æ³¨ä»¶æ•°ã®æ¨ç§»</div>
                <div class="s">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šéå»1å¹´åˆ†ï¼ˆè¡¨ç¤ºä¸­ç¯„å›²ã§ç¸¦è»¸ãŒè‡ªå‹•èª¿æ•´ï¼‰</div>
              </div>
              <div class="badgeBig">
                <div class="k" id="metricLabelA">å—æ³¨ä»¶æ•°</div>
                <div class="v" id="metricValueA">â€”</div>
              </div>
            </div>

            <div class="chartWrap">
              <div class="chartFrame">
                <div class="yAxisFixed" id="yAxisFixedA"></div>
                <div class="chartScroller" id="chartScrollerA">
                  <div class="chartInner chartInnerSwitch">
                    <div class="chartMount" id="chartMountA"></div>
                  </div>
                </div>
              </div>
              <div class="hint">
                <span class="tapHint" id="flipHintA">ğŸ‘† ã‚¿ãƒƒãƒ—ã§ã€Œç·è³‡ç”£ã®æ¨ç§»ã€ã«åˆ‡æ›¿</span>
              </div>
            </div>
          </div>

          <!-- BACKï¼šç·è³‡ç”£ -->
          <div class="cardFace back">
            <div class="cardHead">
              <div class="title">
                <div class="h" id="chartTitleB">ç·è³‡ç”£ã®æ¨ç§»</div>
                <div class="s">æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šéå»1å¹´åˆ†ï¼ˆè¡¨ç¤ºä¸­ç¯„å›²ã§ç¸¦è»¸ãŒè‡ªå‹•èª¿æ•´ï¼‰</div>
              </div>
              <div class="badgeBig">
                <div class="k" id="metricLabelB">ç·è³‡ç”£</div>
                <div class="v" id="metricValueB">â€”</div>
              </div>
            </div>

            <div class="chartWrap">
              <div class="chartFrame">
                <div class="yAxisFixed" id="yAxisFixedB"></div>
                <div class="chartScroller" id="chartScrollerB">
                  <div class="chartInner chartInnerSwitch">
                    <div class="chartMount" id="chartMountB"></div>
                  </div>
                </div>
              </div>
              <div class="hint">
                <span class="tapHint" id="flipHintB">ğŸ‘† ã‚¿ãƒƒãƒ—ã§ã€Œå—æ³¨ä»¶æ•°ã®æ¨ç§»ã€ã«åˆ‡æ›¿</span>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- 2) ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ  -->
      <section class="card">
        <div class="cardHead">
          <div class="title">
            <div class="h">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
            <div class="s">è¦‹ãŸç›®ã®ã¿ï¼ˆå…¥ã‚Œæ–¹ã¯æŒ‡ç¤ºå¾…ã¡ï¼‰</div>
          </div>
          <div class="badgeBig">
            <div class="k">ä»Šæœˆ</div>
            <div class="v" id="calMonthLabel">â€”</div>
          </div>
        </div>

        <div class="calendar">
          <div class="calBox">
            <div class="calBg"></div>
            <div class="calGlass">
              <div class="calTop">
                <div class="month" id="calTitle">â€”</div>
                <div style="font-size:12px;color:rgba(34,34,34,.60);font-weight:900;">Sunâ€“Sat</div>
              </div>

              <div class="calGrid" id="calGrid"></div>

              <div style="padding:10px 4px 0;color:rgba(34,34,34,.55);font-size:11px;">
                â€» å¹´æœ«å¹´å§‹ä¼‘ã¿ãªã©ã®æ³¨æ„æ›¸ãã‚‚ã“ã“ã«ç½®ã‘ã‚‹æƒ³å®š
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) å—æ³¨æ®‹ï¼šstock -->
      <section class="card">
        <div class="listTitle">å—æ³¨æ®‹ï¼šstock</div>
        <div class="list">
          <div class="tableWrap">
            <table class="table" aria-label="stock orders">
              <thead class="thead">
                <tr>
                  <th style="width:46%;">åå‰</th>
                  <th style="width:26%;">æœŸæ—¥</th>
                  <th style="width:18%;">é€²æ—</th>
                  <th style="width:10%; text-align:right;">æ‹…å½“</th>
                </tr>
              </thead>
              <tbody id="stockBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 4) å—æ³¨æ®‹ï¼šorder -->
      <section class="card">
        <div class="listTitle">å—æ³¨æ®‹ï¼šorder</div>
        <div class="list">
          <div class="tableWrap">
            <table class="table" aria-label="made-to-order">
              <thead class="thead">
                <tr>
                  <th style="width:46%;">åå‰</th>
                  <th style="width:26%;">æœŸæ—¥</th>
                  <th style="width:18%;">é€²æ—</th>
                  <th style="width:10%; text-align:right;">æ‹…å½“</th>
                </tr>
              </thead>
              <tbody id="orderBody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </main>

    <!-- OTHER -->
    <main id="view-other" class="grid" style="display:none;">
      <section class="card">
        <div class="cardHead">
          <div class="title">
            <div class="h">OTHER</div>
            <div class="s">ã“ã“ã¯å¾Œã§å¢—ã‚„ã™</div>
          </div>
        </div>
        <div style="padding:14px;color:rgba(34,34,34,.65);">æº–å‚™ä¸­â€¦</div>
      </section>
    </main>
  </div>

<script>
(()=> {
  /* ===== ç”»é¢åˆ‡æ›¿ ===== */
  const tabs = document.querySelectorAll(".tab");
  const viewHome = document.getElementById("view-home");
  const viewOther = document.getElementById("view-other");

  tabs.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const v = btn.dataset.view;
      viewHome.style.display = (v==="home") ? "" : "none";
      viewOther.style.display = (v==="other") ? "" : "none";
    });
  });

  /* ===== ãƒ‡ãƒ¼ã‚¿ ===== */
  const months = ["9æœˆ","10æœˆ","11æœˆ","12æœˆ","1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ"];
  const orders = [3,6,9,7,8,12,10,14,9,6,11,15];
  const assets = [80000,120000,150000,180000,210000,190000,240000,260000,300000,280000,320000,360000];

  const formatJPY = n => "Â¥" + Math.round(n).toLocaleString("ja-JP");
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const down5 = v => Math.floor(v/5)*5;
  const up5   = v => Math.ceil(v/5)*5;

  /* ===== flipè¦ç´  ===== */
  const cardChart = document.getElementById("card-chart");
  const flipHintA = document.getElementById("flipHintA");
  const flipHintB = document.getElementById("flipHintB");

  const A = {
    mount: document.getElementById("chartMountA"),
    yAxis: document.getElementById("yAxisFixedA"),
    scroller: document.getElementById("chartScrollerA"),
    metricValue: document.getElementById("metricValueA"),
    dragging:false,
    _pts:[]
  };
  const B = {
    mount: document.getElementById("chartMountB"),
    yAxis: document.getElementById("yAxisFixedB"),
    scroller: document.getElementById("chartScrollerB"),
    metricValue: document.getElementById("metricValueB"),
    dragging:false,
    _pts:[]
  };

  let isFlipped = false;

  function getVisibleRange(scroller, {padL,xStep,N}){
    const sl = scroller.scrollLeft;
    const vw = scroller.clientWidth;
    const s  = Math.floor((sl-padL)/xStep);
    const e  = Math.ceil(((sl+vw)-padL)/xStep);
    return [clamp(s,0,N-1), clamp(e,0,N-1)];
  }

  function computeScale(series,i0,i1,isOrders){
    const slice = series.slice(i0,i1+1);
    let minV = Math.min(...slice);
    let maxV = Math.max(...slice);

    const range = (maxV-minV) || 1;
    const pad = range*0.05;

    let minS = minV - pad;
    let maxS = maxV + pad;

    if(isOrders){
      minS = down5(minS);
      maxS = up5(maxS);
      if(maxS - minS < 20) maxS = minS + 20;
      if(maxS === minS) maxS = minS + 20;
      return {minS,maxS};
    }else{
      const base = 50000;
      minS = Math.floor(minS/base)*base;
      maxS = Math.ceil (maxS/base)*base;

      let step = Math.ceil(((maxS - minS) / 4) / base) * base;
      if(step < base) step = base;

      maxS = minS + step*4;
      return {minS,maxS,step};
    }
  }

  function makeTicks(minS,maxS,steps=5, stepOpt=null){
    const arr=[];
    if(stepOpt){
      for(let i=0;i<steps;i++) arr.push(minS + stepOpt*i);
      return arr;
    }
    const d=(maxS-minS)/(steps-1);
    for(let i=0;i<steps;i++) arr.push(minS + d*i);
    arr[0]=minS; arr[arr.length-1]=maxS;
    return arr;
  }

  function labelFor(v,isOrders){
    return isOrders ? `${Math.round(v)}` : `${Math.round(v/10000)}ä¸‡`;
  }

  function renderYAxis(elems, {ticks,yToPx,H,isOrders}){
    elems.yAxis.innerHTML = `
      <svg width="42" height="${H}">
        ${ticks.map(v=>{
          const y=yToPx(v);
          return `<text x="34" y="${y+4}" text-anchor="end"
            font-size="11" fill="rgba(34,34,34,.55)" font-weight="900">
            ${labelFor(v,isOrders)}
          </text>`;
        }).join("")}
      </svg>
    `;
  }

  /* ===== tooltip ===== */
  function removeTooltip(svg){
    const old = svg.querySelector(".chartTooltip");
    if(old) old.remove();
  }

  function showTooltip(svg, x, y, text){
    removeTooltip(svg);

    const ns = "http://www.w3.org/2000/svg";
    const g = document.createElementNS(ns, "g");
    g.setAttribute("class","chartTooltip");

    const t = document.createElementNS(ns, "text");
    t.textContent = text;
    t.setAttribute("text-anchor","middle");
    t.setAttribute("x", x);
    t.setAttribute("y", y - 14);

    g.appendChild(t);
    svg.appendChild(g);

    const bbox = t.getBBox();
    const padX = 10, padY = 6;

    const r = document.createElementNS(ns, "rect");
    r.setAttribute("x", bbox.x - padX);
    r.setAttribute("y", bbox.y - padY);
    r.setAttribute("width", bbox.width + padX*2);
    r.setAttribute("height", bbox.height + padY*2);

    g.insertBefore(r, t);
  }

  /* ===== æç”»ï¼ˆé¢ã”ã¨ï¼‰ ===== */
  function renderChartInto(elems, mode, {keepScroll=true} = {}){
    const isOrders = (mode === "orders");
    const series = isOrders ? orders : assets;

    const N=series.length;
    const xStep=96;
    const H=220;
    const padT=14, padB=42, padR=16;
    const innerH=H-padT-padB;
    const W=16 + xStep*(N-1) + padR;

    // â˜…ã“ã“ãŒè¶…é‡è¦ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¹…ã‚’ â€œç¢ºå®Ÿã«â€ ä½œã‚‹
    elems.mount.style.width = `${42 + W}px`;

    const prevSL = elems.scroller.scrollLeft;

    const [i0,i1] = getVisibleRange(elems.scroller, {padL:42, xStep, N});
    const scale = computeScale(series,i0,i1,isOrders);
    const ticks = makeTicks(scale.minS, scale.maxS, 5, scale.step || null);
    const {minS,maxS} = scale;

    const latest=series[N-1];
    elems.metricValue.textContent = isOrders ? `${latest}ä»¶` : formatJPY(latest);

    const denom = (maxS - minS) || 1;
    const yToPx = v => padT + (1 - (v - minS) / denom) * innerH;

    renderYAxis(elems, {ticks,yToPx,H,isOrders});

    const pts = series.map((v,i)=>({x:42+i*xStep, y:yToPx(v), v}));
    const path = pts.map((p,i)=> i ? `L ${p.x},${p.y}` : `M ${p.x},${p.y}`).join(" ");

    elems.mount.innerHTML = `
      <svg width="${42+W}" height="${H}" viewBox="0 0 ${42+W} ${H}">
        ${ticks.map(v=>{
          const y=yToPx(v);
          return `<line x1="42" y1="${y}" x2="${42+W-padR}" y2="${y}" stroke="rgba(0,0,0,.10)"/>`;
        }).join("")}

        <path d="${path} L ${pts.at(-1).x},${padT+innerH} L ${pts[0].x},${padT+innerH} Z"
              fill="rgba(225,138,106,.18)"/>

        <path d="${path}" fill="none" stroke="rgba(225,138,106,.95)"
              stroke-width="3" stroke-linecap="round"/>

        ${pts.map(p=>`
          <circle cx="${p.x}" cy="${p.y}" r="6"
            fill="rgba(255,255,255,.95)" stroke="rgba(34,34,34,.28)" stroke-width="2"/>
        `).join("")}

        ${months.map((m,i)=>`
          <text x="${42+i*xStep}" y="${H-18}" text-anchor="middle"
            font-size="12" fill="rgba(34,34,34,.65)" font-weight="900">${m}</text>
        `).join("")}
      </svg>
    `;

    elems._pts = pts.map(p=>({
      x:p.x, y:p.y,
      label: isOrders ? `${p.v}ä»¶` : formatJPY(p.v)
    }));

    // â˜…åˆå›ã ã‘å³ç«¯ï¼ˆæœ€æ–°æœˆï¼‰ã¸
    if(!keepScroll){
      elems.scroller.scrollLeft = elems.scroller.scrollWidth - elems.scroller.clientWidth;
    }else{
      elems.scroller.scrollLeft = prevSL;
    }
  }

  /* ===== ã‚¿ãƒƒãƒ—ã§è¿‘ã„ç‚¹â†’tooltipï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜»å®³ã—ãªã„ï¼‰ ===== */
  function attachTapToShowTooltip(elems){
    let downX=0, downY=0, moved=false;

    const onDown = (e)=>{
      elems.dragging = true;
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      downX=p.clientX; downY=p.clientY;
      moved=false;
    };
    const onMove = (e)=>{
      const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
      if(Math.abs(p.clientX-downX)>6 || Math.abs(p.clientY-downY)>6) moved=true;
    };
    const onUp = (e)=>{
      elems.dragging = false;
      if(moved) return;

      const svg = elems.mount.querySelector("svg");
      if(!svg) return;

      const rect = svg.getBoundingClientRect();
      const p = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0] : e;
      const x = p.clientX - rect.left;
      const y = p.clientY - rect.top;

      if(x<0 || y<0 || x>rect.width || y>rect.height){
        removeTooltip(svg);
        return;
      }

      const vb = svg.viewBox.baseVal;
      const sx = vb.width / rect.width;
      const sy = vb.height / rect.height;
      const vx = x * sx;
      const vy = y * sy;

      const pts = elems._pts || [];
      let best=null, bestD=1e9;
      for(const pt of pts){
        const dx=pt.x-vx, dy=pt.y-vy;
        const d2=dx*dx+dy*dy;
        if(d2<bestD){bestD=d2; best=pt;}
      }

      const threshold = 14*14;
      if(best && bestD<=threshold){
        showTooltip(svg, best.x, best.y, best.label);
      }else{
        removeTooltip(svg);
      }
    };

    elems.scroller.addEventListener("pointerdown", onDown, {passive:true});
    elems.scroller.addEventListener("pointermove", onMove, {passive:true});
    elems.scroller.addEventListener("pointerup",   onUp,   {passive:true});

    elems.scroller.addEventListener("touchstart", onDown, {passive:true});
    elems.scroller.addEventListener("touchmove",  onMove, {passive:true});
    elems.scroller.addEventListener("touchend",   onUp,   {passive:true});
  }

  /* ===== ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«çµ‚äº†å¾Œã«ç¸¦è»¸ã‚’æ›´æ–°ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã¯é‚ªé­”ã—ãªã„ï¼‰ ===== */
  function attachEndRedraw(elems, mode){
    let timer = 0;
    const fire = ()=>{
      clearTimeout(timer);
      timer = setTimeout(()=>{
        renderChartInto(elems, mode, {keepScroll:true});
      }, 120);
    };
    elems.scroller.addEventListener("scroll", fire, {passive:true});
  }

  attachEndRedraw(A, "orders");
  attachEndRedraw(B, "assets");

  /* ===== åˆæœŸæç”» ===== */
  renderChartInto(A, "orders", {keepScroll:false});
  renderChartInto(B, "assets", {keepScroll:false});
  attachTapToShowTooltip(A);
  attachTapToShowTooltip(B);

  /* ===== åˆ‡æ›¿ï¼ˆãƒãƒ£ãƒ¼ãƒˆéƒ¨åˆ†ã‚’è§¦ã£ã¦ã‚‚åˆ‡æ›¿ã—ãªã„ï¼‰ ===== */
  function flip(){
    isFlipped = !isFlipped;
    cardChart.classList.add("is-animating");
    cardChart.classList.toggle("is-flipped", isFlipped);
    setTimeout(()=> cardChart.classList.remove("is-animating"), 280);
  }

  // ã€Œã‚°ãƒ©ãƒ•é ˜åŸŸã€ã¯ flip ã•ã›ãªã„ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ€å„ªå…ˆï¼‰
  cardChart.addEventListener("click", (e)=>{
    if(e.target.closest(".chartWrap")) return;
    flip();
  });
  flipHintA.addEventListener("click", (e)=>{ e.stopPropagation(); flip(); });
  flipHintB.addEventListener("click", (e)=>{ e.stopPropagation(); flip(); });

  /* ===== ä»¥ä¸‹ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå…ƒã®ã¾ã¾ï¼‰ ===== */
  const calMonthLabel = document.getElementById("calMonthLabel");
  const calTitle = document.getElementById("calTitle");
  const calGrid = document.getElementById("calGrid");

  const calYear = 2025, calMonth = 12;
  calMonthLabel.textContent = `${calMonth}æœˆ`;
  calTitle.textContent = `${calYear}.${String(calMonth).padStart(2,"0")}`;

  const dows = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  calGrid.innerHTML = dows.map(d=>`<div class="dow">${d}</div>`).join("");

  const first = new Date(calYear, calMonth-1, 1);
  const firstDow = first.getDay();
  const lastDay = new Date(calYear, calMonth, 0).getDate();

  const events = {
    10: [{t:"POP UP", style:"accent"}],
    11: [{t:"POP UP", style:"accent"}],
    12: [{t:"ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼å€‰åº«", style:"soft"}],
    20: [{t:"storyè²©å£²", style:"accent"}],
    27: [{t:"å®šä¼‘æ—¥", style:"soft"}],
    31: [{t:"å®šä¼‘æ—¥", style:"soft"}],
  };

  const totalCells = 42;
  for(let i=0;i<totalCells;i++){
    const dayNum = i - firstDow + 1;
    if(dayNum < 1 || dayNum > lastDay){
      calGrid.insertAdjacentHTML("beforeend", `<div class="day" style="opacity:.35;"></div>`);
    }else{
      const ev = events[dayNum] || [];
      const pills = ev.map(e=>`<span class="pill ${e.style}">${e.t}</span>`).join("");
      calGrid.insertAdjacentHTML("beforeend", `
        <div class="day">
          <div class="num">${dayNum}</div>
          ${pills}
        </div>
      `);
    }
  }

  const stockBody = document.getElementById("stockBody");
  const orderBody = document.getElementById("orderBody");

  const stockRows = [
    {name:"ä¸‹é§„ç®±æ¨™æº–PB", due:"2025/06/19", status:"é€²è¡Œä¸­", st:"doing", assignees:["å·åŸ"]},
    {name:"å”è­°ç”¨å›³é¢ä½œæˆ", due:"2025/07/24", status:"é€²è¡Œä¸­", st:"doing", assignees:["è—¤åŸ","å·åŸ"]},
    {name:"å¤–å£ã‚µãƒ³ãƒ—ãƒ«å…¨é›†ã‚", due:"2025/07/31", status:"å¾…ã¡", st:"wait", assignees:["è—¤åŸ"]},
    {name:"å¿˜å¹´ä¼š", due:"2025/12/20", status:"é€²è¡Œä¸­", st:"doing", assignees:["å·åŸ"]},
  ];

  const orderRows = [
    {name:"ã‚ªãƒ¼ãƒ€ãƒ¼ï¼šãƒãƒ–ãƒ¼ã‚·ãƒ¥ã‚«A", due:"2025/06/28", status:"æœªç€æ‰‹", st:"todo", assignees:["è—¤åŸ"]},
    {name:"ã‚ªãƒ¼ãƒ€ãƒ¼ï¼šãƒ‰ãƒ¬ã‚¹B", due:"2025/07/05", status:"é€²è¡Œä¸­", st:"doing", assignees:["å·åŸ"]},
    {name:"ã‚ªãƒ¼ãƒ€ãƒ¼ï¼šåˆºç¹C", due:"2025/07/12", status:"å®Œäº†", st:"done", assignees:["è—¤åŸ","å·åŸ"]},
  ];

  function statusClass(st){
    if(st==="doing") return "st-doing";
    if(st==="wait")  return "st-wait";
    if(st==="done")  return "st-done";
    return "st-todo";
  }

  function renderRows(mount, rows){
    mount.innerHTML = rows.map(r=>`
      <tr class="row">
        <td>${r.name}</td>
        <td>${r.due}</td>
        <td><span class="status ${statusClass(r.st)}"><span class="dot"></span>${r.status}</span></td>
        <td style="text-align:right;">${r.assignees.join(" / ")}</td>
      </tr>
    `).join("");
  }

  renderRows(stockBody, stockRows);
  renderRows(orderBody, orderRows);
})();
</script>

</body>
</html>
