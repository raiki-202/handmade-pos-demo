<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* =========================
   Firebase
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCINAN5ciYMvKhnrm7thQ8mhK1rL8KQu_o",
  authDomain: "handmade-pos-dev.firebaseapp.com",
  projectId: "handmade-pos-dev",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   DOM
========================= */
const productsWrap = document.getElementById("products");
const totalText   = document.getElementById("totalText");
const masterPill  = document.getElementById("masterCount");

/* =========================
   Load Products
========================= */
let products = [];

async function loadProducts() {
  /* --- ① bundle --- */
  const bundleRes = await fetch("./products_bundle.json");
  const bundle = await bundleRes.json();

  products = structuredClone(bundle.products);

  /* --- ② patch --- */
  const snap = await getDocs(collection(db, "products_patch"));
  console.log("patch docs:", snap.size, snap.docs.map(d => d.id));

  let patchCount = 0;

  snap.forEach(doc => {
    const patch = doc.data();
    const target = products.find(p => p.id === doc.id);
    if (!target) return;

    Object.keys(patch).forEach(key => {
      if (key === "updatedAt") return;
      target[key] = patch[key];
    });
    patchCount++;
  });

  /* --- 表示 --- */
  if (masterPill) {
    masterPill.textContent = `商品マスタ：${products.length}件（patch ${patchCount}）`;
  }

  renderProducts();
}

/* =========================
   Render
========================= */
function renderProducts() {
  productsWrap.innerHTML = "";

  products
    .filter(p => p.active !== false)
    .forEach(p => {
      const row = document.createElement("div");
      row.className = "product-row";

      row.innerHTML = `
        <label style="display:flex;align-items:center;gap:10px;width:100%;">
          <input type="checkbox" data-id="${p.id}">
          <span style="flex:1">${p.name} ￥${p.price}</span>
          <select disabled>
            ${Array.from({length:10},(_,i)=>`<option>${i+1}</option>`).join("")}
          </select>
          <span>個</span>
        </label>
      `;

      const cb  = row.querySelector("input");
      const sel = row.querySelector("select");

      cb.addEventListener("change", () => {
        sel.disabled = !cb.checked;
        updateTotal();
      });
      sel.addEventListener("change", updateTotal);

      productsWrap.appendChild(row);
    });

  updateTotal();
}

/* =========================
   Total
========================= */
function updateTotal() {
  let total = 0;
  document.querySelectorAll(".product-row").forEach(row => {
    const cb  = row.querySelector("input");
    const sel = row.querySelector("select");
    if (!cb.checked) return;

    const p = products.find(x => x.id === cb.dataset.id);
    total += p.price * Number(sel.value);
  });
  totalText.textContent = `合計：￥${total}`;
}

/* =========================
   Init
========================= */
loadProducts();
</script>
